name: Generate Index Pages

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate index.html for every folder
        run: |
          python3 << 'PYSCRIPT'
          import os, urllib.parse, html as html_mod

          REPO = "heshamrokaia/Deakin-Master-Business-Analytics"
          GITHUB_BASE = f"https://github.com/{REPO}/blob/main"
          GITHUB_TREE = f"https://github.com/{REPO}/tree/main"
          HTMLPREVIEW = "https://htmlpreview.github.io/?https://github.com/" + REPO + "/blob/main"

          def get_icon(name, is_dir=False):
              if is_dir: return "&#128193;"
              ext = name.rsplit(".", 1)[-1].lower() if "." in name else ""
              icons = {"pdf":"&#128196;","ipynb":"&#128211;","html":"&#127760;","py":"&#128013;","csv":"&#128202;","xlsx":"&#128202;","xls":"&#128202;","pptx":"&#127902;","ppt":"&#127902;","docx":"&#128221;","doc":"&#128221;","txt":"&#128221;","zip":"&#128230;","png":"&#128444;","jpg":"&#128444;","jpeg":"&#128444;","r":"&#128200;","rmd":"&#128200;","mhtml":"&#127760;","json":"&#9881;","sql":"&#128451;","accdb":"&#128451;","sas7bdat":"&#128202;","arff":"&#128202;","twbx":"&#128202;","pbix":"&#128202;"}
              return icons.get(ext, "&#128196;")

          def get_link(path, name):
              encoded = urllib.parse.quote(path)
              ext = name.rsplit(".", 1)[-1].lower() if "." in name else ""
              if ext in ("html", "mhtml"):
                  return f"{HTMLPREVIEW}/{encoded}"
              return f"{GITHUB_BASE}/{encoded}"

          def gen_index(dirpath, entries, parent=None):
              dirname = os.path.basename(dirpath) or dirpath
              safe = html_mod.escape(dirname)
              dirs = sorted([e for e in entries if os.path.isdir(os.path.join(dirpath, e))], key=str.lower)
              files = sorted([e for e in entries if os.path.isfile(os.path.join(dirpath, e)) and e != "index.html"], key=str.lower)
              back = '<li class="i d"><a href="../index.html">&#11014;&#65039; Back</a></li>' if parent else ""
              d_html = ""
              for d in dirs:
                  dn = html_mod.escape(d)
                  d_html += f'<li class="i d"><a href="{urllib.parse.quote(d)}/index.html">&#128193; {dn}/</a></li>'
              f_html = ""
              for fn in files:
                  fp = os.path.relpath(os.path.join(dirpath, fn), ".")
                  ext = fn.rsplit(".", 1)[-1].lower() if "." in fn else ""
                  icon = get_icon(fn)
                  link = get_link(fp, fn)
                  tgt = ' target="_blank"' if ext in ("html","mhtml") else ""
                  f_html += f'<li class="i f"><a href="{link}"{tgt}>{icon} {html_mod.escape(fn)} <span class="x">.{ext}</span></a></li>'
              rel = os.path.relpath(dirpath, ".")
              gh_link = f"{GITHUB_TREE}/{urllib.parse.quote(rel)}"
              page = f"""<!DOCTYPE html>
          <html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>{safe}</title>
          <style>*{{margin:0;padding:0;box-sizing:border-box}}body{{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#0d1117;color:#c9d1d9;padding:20px;max-width:900px;margin:0 auto}}h1{{color:#58a6ff;font-size:1.5em;padding:15px 0;border-bottom:1px solid #30363d;margin-bottom:10px}}.s{{width:100%;padding:10px 15px;background:#161b22;border:1px solid #30363d;border-radius:6px;color:#c9d1d9;font-size:14px;margin-bottom:15px}}.s:focus{{outline:none;border-color:#58a6ff}}ul{{list-style:none}}.i{{border-bottom:1px solid #21262d}}.i a{{display:block;padding:10px 15px;color:#c9d1d9;text-decoration:none;transition:background .15s}}.i a:hover{{background:#161b22;color:#58a6ff}}.i.d a{{color:#58a6ff}}.x{{color:#8b949e;font-size:.85em}}.c{{color:#8b949e;font-size:.9em;padding:5px 0 15px}}.g{{display:inline-block;margin-top:15px;padding:8px 16px;background:#21262d;color:#58a6ff;border-radius:6px;text-decoration:none;font-size:.9em}}.g:hover{{background:#30363d}}</style></head>
          <body><h1>{safe}</h1><p class="c">{len(dirs)} folder(s), {len(files)} file(s)</p>
          <input type="text" class="s" placeholder="Search files..." oninput="document.querySelectorAll('#fl .i').forEach(e=>e.style.display=e.textContent.toLowerCase().includes(this.value.toLowerCase())?'':'none')">
          <ul id="fl">{back}{d_html}{f_html}</ul>
          <a class="g" href="{gh_link}" target="_blank">View on GitHub</a></body></html>"""
              return page

          count = 0
          for root, dirs, files in os.walk("."):
              if root.startswith("./.git"):
                  continue
              entries = dirs + files
              if not entries:
                  continue
              index_path = os.path.join(root, "index.html")
              if os.path.basename(root) == ".":
                  continue
              parent = os.path.dirname(root) if root != "." else None
              page = gen_index(root, os.listdir(root), parent)
              with open(index_path, "w") as f:
                  f.write(page)
              count += 1

          print(f"Generated {count} index.html files")
          PYSCRIPT

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Add browsable index pages for all folders"
          git push
